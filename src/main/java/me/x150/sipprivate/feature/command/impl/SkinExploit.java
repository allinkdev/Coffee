package me.x150.sipprivate.feature.command.impl;

import me.x150.sipprivate.feature.command.Command;
import me.x150.sipprivate.feature.module.ModuleRegistry;
import me.x150.sipprivate.feature.module.impl.exploit.SkinChangeExploit;
import me.x150.sipprivate.helper.Texture;
import me.x150.sipprivate.helper.util.Utils;

import javax.imageio.ImageIO;
import java.awt.image.BufferedImage;
import java.io.ByteArrayInputStream;
import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;

public class SkinExploit extends Command {
    public SkinExploit() {
        super("SkinExploit", "Config for the SkinExploit module", "skinexploit");
    }

    @Override
    public String[] getSuggestions(String fullCommand, String[] args) {
        if (args.length == 1) {
            return new String[]{"(skin url)"};
        }
        return super.getSuggestions(fullCommand, args);
    }

    @Override
    public void onExecute(String[] args) {
        if (args.length == 0) {
            error("Need skin URL");
            return;
        }
        URI uri;
        try {
            uri = new URI(String.join(" ", args));
        } catch (Exception ignored) {
            error("URL invalid");
            return;
        }
        byte[] in;
        try {
            HttpClient hc = HttpClient.newBuilder().followRedirects(HttpClient.Redirect.ALWAYS).build();
            HttpRequest hrc = HttpRequest.newBuilder().uri(uri).header("User-Agent", "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:95.0) Gecko/20100101 Firefox/95.0").build();
            HttpResponse<byte[]> is = hc.send(hrc, HttpResponse.BodyHandlers.ofByteArray());
            in = is.body();
        } catch (Exception e) {
            error("Image load failed: " + e.getMessage());
            e.printStackTrace();
            return;
        }
        try {
            ByteArrayInputStream bais = new ByteArrayInputStream(in);
            BufferedImage bi = ImageIO.read(bais);
            if (bi == null) {
                throw new IllegalStateException("Invalid image data");
            }
            Texture e = new Texture("fakeskintex");
            Utils.registerBufferedImageTexture(e, bi);
            ModuleRegistry.getByClass(SkinChangeExploit.class).skinId = e;
            success("Set skin texture! Enable the module to change everyone's skin");
        } catch (Exception e) {
            error("Image parse failed: " + e.getMessage());
            e.printStackTrace();
        }
    }
}
